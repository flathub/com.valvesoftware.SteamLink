app-id: com.valvesoftware.SteamLink
runtime: org.freedesktop.Platform
runtime-version: '25.08'
sdk: org.freedesktop.Sdk
command: steamlink

finish_args:
  - --device=all
  - --env=LD_LIBRARY_PATH=/app/lib
  - --env=SDL_GAMECONTROLLERCONFIG_FILE=/var/data/Valve Corporation/SteamLink/controller_map.txt
  - --share=ipc
  - --share=network
  - --socket=fallback-x11
  - --socket=pulseaudio
  - --socket=wayland

tags:
  - proprietary

modules:
  - name: qt6-qtbase
    buildsystem: cmake-ninja
    config-opts: [-DINSTALL_ARCHDATADIR=lib, -DQT_DISABLE_RPATH=ON, -DBUILD_WITH_PCH=FALSE,
      -DQT_FEATURE_openssl_linked=ON, -DQT_FEATURE_system_sqlite=ON, -DQT_FEATURE_glibc_fortify_source=OFF]
    sources:
      - type: archive
        url: https://download.qt.io/archive/qt/6.9/6.9.2/submodules/qtbase-everywhere-src-6.9.2.tar.xz
        mirror-urls:
          - https://repo.steampowered.com/steamlink/qtbase-everywhere-src-6.9.2.tar.xz
        sha256: 44be9c9ecfe04129c4dea0a7e1b36ad476c9cc07c292016ac98e7b41514f2440

      - type: patch
        path: patches/steamlink/qtbase.patch
        strip-components: 2
      - type: patch
        path: patches/org.kde.Sdk/qtbase-find_package-paths.patch
    cleanup:
      - /bin
      - /doc
      - /include
      - /lib/*.a
      - /lib/*.la
      - /lib/*.prl
      - /lib/cmake
      - /lib/mkspecs
      - /lib/pkgconfig

  - name: qt6-qtsvg
    buildsystem: cmake-ninja
    sources:
      - type: archive
        url: http://download.qt.io/archive/qt/6.9/6.9.2/submodules/qtsvg-everywhere-src-6.9.2.tar.xz
        mirror-urls:
          - https://repo.steampowered.com/steamlink/qtsvg-everywhere-src-6.9.2.tar.xz
        sha256: d984cab8f26334aa1c15e5b8f0cd9f1b7c0c1289fe0b68c1c84ab469b75605a5
    cleanup:
      - /bin
      - /include
      - /lib/*.a
      - /lib/*.la
      - /lib/*.prl
      - /lib/cmake
      - /lib/mkspecs
      - /lib/pkgconfig

  - name: qt6-wayland
    buildsystem: cmake-ninja
    sources:
      - type: archive
        url: http://download.qt.io/archive/qt/6.9/6.9.2/submodules/qtwayland-everywhere-src-6.9.2.tar.xz
        mirror-urls:
          - https://repo.steampowered.com/steamlink/qtwayland-everywhere-src-6.9.2.tar.xz
        sha256: cad79806565568f12f9983fed69219416abcee9d5deef4abdfcf94aa2eef7781
      - type: patch
        path: patches/org.kde.Sdk/qtwayland-use-adwaita-decorations-on-gnome-by-default.patch
    cleanup:
      - /bin
      - /include
      - /lib/*.a
      - /lib/*.la
      - /lib/*.prl
      - /lib/cmake
      - /lib/mkspecs
      - /lib/pkgconfig

  - name: steamlink-binary
    sources:
      - type: archive
        url: https://repo.steampowered.com/steamlink/1.3.20.295/steamlink-1.3.20.295.tgz
        sha256: 49666bb8cef6ebaf1956acdbb40aa3d577bed40175e1217faf678da91600eef2
        strip-components: 1
        x-checker-data:
          is-main-source: true
          type: html
          url: https://repo.steampowered.com/steamlink/latest/
          version-pattern: href="steamlink-(\d[\d.-]*)\.tgz"
          url-template: https://repo.steampowered.com/steamlink/$version/steamlink-$version.tgz
      - type: file
        path: LICENSE.txt
        dest-filename: LICENSE.txt-from-git
      - type: file
        path: ThirdPartyLegalNotices.css
        dest-filename: ThirdPartyLegalNotices.css-from-git
      - type: file
        path: ThirdPartyLegalNotices.html
        dest-filename: ThirdPartyLegalNotices.html-from-git
    buildsystem: simple
    build-commands:
      - install bin/steamlink /app/bin
      - cp -a lib/* /app/lib
      - cp -a *.txt *.css *.html /app
      # Make sure the license information in the packaging repository is
      # in sync with what's in the binary releases
      - cmp LICENSE.txt LICENSE.txt-from-git
      - cmp ThirdPartyLegalNotices.css ThirdPartyLegalNotices.css-from-git
      - cmp ThirdPartyLegalNotices.html ThirdPartyLegalNotices.html-from-git

  - name: packaging
    sources:
      - type: file
        path: com.valvesoftware.SteamLink.metainfo.xml
      - type: file
        path: com.valvesoftware.SteamLink.desktop
      - type: dir
        path: icons
    buildsystem: simple
    build-commands:
      - install -d /app/share/applications/
      - install -d /app/share/metainfo/
      - install -D -m644 com.valvesoftware.SteamLink.metainfo.xml /app/share/metainfo/
      - install -D -m644 com.valvesoftware.SteamLink.desktop /app/share/applications/
      - |
        set -eu; for size in 256; do
          src="$size/steamlink.png"
          dst="/app/share/icons/hicolor/${size}x${size}/apps/${FLATPAK_ID}.png"
          install -D -m644 "$src" "$dst"
        done
